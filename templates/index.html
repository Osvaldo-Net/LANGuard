<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LAN Guard</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flag-icons/css/flag-icons.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            accent:    "#f4a261",
            highlight: "#e76f51",
            dark1:     "#1a1b1e",
            dark2:     "#25262b",
            dark3:     "#2c2e33"
          },
          fontFamily: { sans: ["Inter", "sans-serif"] }
        }
      }
    };
  </script>
  <style>
    @keyframes fade-in { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
    .fade-in  { animation: fade-in .35s ease-out forwards; }
    .custom-scrollbar::-webkit-scrollbar { width:4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background:rgba(244,162,97,.5); border-radius:4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background:transparent; }
    .no-scroll::-webkit-scrollbar { display:none; }
    .no-scroll { -ms-overflow-style:none; scrollbar-width:none; }
    /* top session bar */
    #sess-bar { transition: width 1s linear; }
    /* compact table rows */
    .dev-row td { padding-top:.5rem; padding-bottom:.5rem; }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 font-sans antialiased text-xs dark:bg-dark1 dark:text-gray-200">

  <!-- Session bar (top) -->
  <div class="fixed top-0 left-0 right-0 z-[90] h-0.5 bg-gray-200 dark:bg-gray-700">
    <div id="sess-bar" class="h-full bg-gradient-to-r from-accent to-highlight" style="width:100%"></div>
  </div>
  <!-- Session expiry warning -->
  <div id="sess-warn" class="hidden fixed top-0.5 left-0 right-0 z-[91] bg-red-500 text-white text-xs text-center py-1 font-medium">
    <span data-i18n="sessionWarning">⚠ Tu sesión expirará pronto.</span>
    <button onclick="keepAlive()" class="underline ml-2" data-i18n="sessionKeepAlive">Mantener activa</button>
  </div>

  <button id="toggleMenu" class="fixed top-3 left-3 z-50 bg-accent text-white p-1.5 rounded-lg shadow sm:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
  </button>
  <div id="overlay" class="fixed inset-0 bg-black/40 z-40 hidden sm:hidden"></div>

  <!-- ══════════ SIDEBAR ══════════ -->
  <aside id="sidebar" class="fixed top-0 left-0 h-full w-56 bg-white dark:bg-dark2 border-r border-gray-200 dark:border-gray-700/60 flex flex-col z-50 -translate-x-full sm:translate-x-0 transition-transform duration-300 shadow-lg">

    <div class="h-12 flex items-center justify-center border-b border-gray-200 dark:border-gray-700/60">
      <span class="text-xl font-semibold tracking-tight">
        <span class="text-accent">LAN</span><span class="dark:text-gray-100">Guard</span>
      </span>
    </div>

    <nav class="flex-1 px-3 py-3 space-y-1.5 overflow-y-auto custom-scrollbar text-xs">

      <button onclick="escanearAhora()" class="w-full bg-gradient-to-r from-accent to-highlight hover:opacity-90 text-white py-1.5 px-3 rounded-lg flex items-center gap-2 transition">
        <i data-lucide="scan" class="w-3.5 h-3.5"></i>
        <span data-i18n="scan">Escanear</span>
      </button>

      <!-- Idioma -->
      <div class="relative">
        <button id="langBtn" class="w-full flex items-center justify-between px-2.5 py-1.5 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-dark3 hover:bg-accent/10 transition">
          <div class="flex items-center gap-1.5">
            <span id="langFlag" class="fi fi-es w-4 h-3 rounded-sm"></span>
            <span id="langLabel">Español</span>
          </div>
          <i data-lucide="chevron-down" class="w-3 h-3 text-accent"></i>
        </button>
        <div id="langMenu" class="absolute z-50 mt-1 w-full bg-white dark:bg-dark2 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg hidden">
          <button onclick="setLang('es','es','Español')" class="w-full flex items-center gap-2 px-2.5 py-1.5 hover:bg-accent/10 text-left">
            <span class="fi fi-es w-4 h-3 rounded-sm"></span> Español
          </button>
          <button onclick="setLang('en','us','English')" class="w-full flex items-center gap-2 px-2.5 py-1.5 hover:bg-accent/10 text-left">
            <span class="fi fi-us w-4 h-3 rounded-sm"></span> English
          </button>
        </div>
      </div>

      <!-- Tema -->
      <button onclick="toggleDarkMode()" class="w-full flex items-center gap-2 px-2.5 py-1.5 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-accent/10 transition text-gray-600 dark:text-gray-300">
        <i id="icono-luna" data-lucide="moon" class="w-3.5 h-3.5"></i>
        <i id="icono-sol"  data-lucide="sun"  class="w-3.5 h-3.5 hidden"></i>
        <span data-i18n="changeTheme">Cambiar tema</span>
      </button>

      <!-- Historial -->
      <button id="btn-historial" onclick="toggleHistorial()" class="w-full flex items-center gap-2 px-2.5 py-1.5 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-accent/10 transition text-gray-600 dark:text-gray-300">
        <i data-lucide="history" class="w-3.5 h-3.5 text-accent"></i>
        <span data-i18n="history">Historial</span>
      </button>

      <!-- Configuración -->
      <button onclick="abrirConfig()" class="w-full flex items-center gap-2 px-2.5 py-1.5 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-accent/10 transition text-gray-600 dark:text-gray-300">
        <i data-lucide="settings" class="w-3.5 h-3.5"></i>
        <span data-i18n="settings">Configuración</span>
      </button>

    </nav>

    <div class="px-3 py-3 border-t border-gray-200 dark:border-gray-700/60 space-y-2">

      <!-- Reloj rediseñado -->
      <div class="bg-gray-50 dark:bg-dark3/70 rounded-xl px-3 py-2.5 flex flex-col items-center gap-0.5">
        <span id="horaActual-time" class="text-lg font-semibold tabular-nums tracking-tight text-gray-800 dark:text-gray-100 leading-none"></span>
        <span id="horaActual-date" class="text-gray-400 dark:text-gray-500 tabular-nums leading-none" style="font-size:10px"></span>
      </div>

      <!-- Usuario -->
      <div class="flex items-center gap-1.5 px-1 text-gray-400 truncate">
        <i data-lucide="user" class="w-3 h-3 flex-shrink-0"></i>
        <span class="truncate" style="font-size:10px">{{ usuario_actual }}</span>
      </div>

      <a href="/logout" class="w-full bg-red-500 hover:bg-red-600 text-white py-1.5 px-3 rounded-lg flex items-center gap-2 transition">
        <i data-lucide="log-out" class="w-3.5 h-3.5"></i>
        <span data-i18n="logout">Cerrar sesión</span>
      </a>
      <p class="text-center text-gray-400" style="font-size:10px">LANGuard v3.3.0</p>
    </div>
  </aside>

  <!-- ══════════ MAIN ══════════ -->
  <main class="sm:ml-56 ml-0 px-4 py-4 pt-3 fade-in">

    <!-- Filtros -->
    <div class="mb-3 grid grid-cols-1 sm:grid-cols-3 gap-2">
      <input id="filtro-nombre" type="text" data-i18n="filterName" placeholder="Filtrar por nombre"
        class="p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-dark2 focus:ring-1 focus:ring-accent focus:outline-none text-xs" />
      <input id="filtro-mac" type="text" data-i18n="filterMac" placeholder="Filtrar por MAC"
        class="p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-dark2 focus:ring-1 focus:ring-accent focus:outline-none text-xs font-mono" />
      <!-- Dropdown igual al del historial -->
      <div class="relative">
        <button id="trustBtn" class="w-full flex items-center justify-between px-2.5 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-dark2 hover:bg-accent/10 transition text-xs">
          <div class="flex items-center gap-1.5">
            <span id="trust-dot" class="inline-block w-2 h-2 rounded-full bg-gray-400"></span>
            <span id="trustLabel" data-i18n="filterAll">Todos</span>
          </div>
          <i data-lucide="chevron-down" class="w-3 h-3 text-accent"></i>
        </button>
        <div id="trustMenu" class="absolute z-40 mt-1 w-full bg-white dark:bg-dark2 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg hidden">
          <button onclick="setTrustFilter('all')"       class="w-full px-2.5 py-1.5 text-left hover:bg-accent/10 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-gray-400 flex-shrink-0"></span><span data-i18n="filterAll">Todos</span></button>
          <button onclick="setTrustFilter('trusted')"   class="w-full px-2.5 py-1.5 text-left hover:bg-accent/10 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-500 flex-shrink-0"></span><span data-i18n="filterTrusted">Confiables</span></button>
          <button onclick="setTrustFilter('untrusted')" class="w-full px-2.5 py-1.5 text-left hover:bg-accent/10 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-red-500 flex-shrink-0"></span><span data-i18n="filterUntrusted">No confiables</span></button>
        </div>
      </div>
    </div>

    <!-- Tabla dispositivos -->
    <section class="overflow-x-auto no-scroll rounded-xl border border-gray-200 dark:border-gray-700/60 bg-white dark:bg-dark2 shadow-sm mb-4">
      <table class="min-w-[640px] w-full table-auto">
        <thead class="bg-gray-50 dark:bg-dark3 text-gray-500 dark:text-gray-400 text-xs">
          <tr>
            <th class="px-3 py-2 text-left font-medium"><span data-i18n="ip">IP</span></th>
            <th class="px-3 py-2 text-left font-medium"><span data-i18n="mac">MAC</span></th>
            <th class="px-3 py-2 text-left font-medium"><span data-i18n="name">Nombre</span></th>
            <th class="px-3 py-2 text-left font-medium"><span data-i18n="manufacturer">Fabricante</span></th>
            <th class="px-3 py-2 text-left font-medium"><span data-i18n="trust">Confianza</span></th>
            <th class="px-3 py-2 text-left font-medium"><span data-i18n="action">Acción</span></th>
            <th class="px-3 py-2 text-left font-medium"><span data-i18n="ports">Puertos</span></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100 dark:divide-gray-700/50" id="tabla-dispositivos">
          {% for d in dispositivos %}
          <tr class="dev-row hover:bg-gray-50 dark:hover:bg-dark3/50 dispositivo-row transition"
              data-nombre="{{ (d.nombre or '') | lower }}"
              data-mac="{{ d.mac | lower }}"
              data-confianza="{{ 'confiable' if d.confiable else 'no-confiable' }}">
            <td class="px-3 font-mono text-gray-500 dark:text-gray-400">{{ d.ip }}</td>
            <td class="px-3 font-mono text-gray-400 dark:text-gray-500">{{ d.mac }}</td>
            <td class="px-3">
              <div class="flex items-center gap-1.5">
                <span class="text-gray-700 dark:text-gray-200">{{ d.nombre or "—" }}</span>
                <button onclick="editarNombre('{{ d.mac }}')" class="text-gray-300 hover:text-accent transition">
                  <i data-lucide="pencil" class="w-3 h-3"></i>
                </button>
              </div>
            </td>
            <td class="px-3 text-gray-500 dark:text-gray-400">{{ d.fabricante or "—" }}</td>
            <td class="px-3">
              {% if d.confiable %}
              <span class="inline-flex items-center gap-1 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 px-2 py-0.5 rounded-full font-medium">
                <span class="relative flex w-1.5 h-1.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full w-1.5 h-1.5 bg-emerald-500"></span></span>
                <span data-i18n="trusted">Confiable</span>
              </span>
              {% else %}
              <span class="inline-flex items-center gap-1 bg-red-100 dark:bg-red-900/20 text-red-600 dark:text-red-400 px-2 py-0.5 rounded-full font-medium">
                <span class="w-1.5 h-1.5 rounded-full bg-gray-400"></span>
                <span data-i18n="untrusted">No confiable</span>
              </span>
              {% endif %}
            </td>
            <td class="px-3">
              {% if not d.confiable %}
              <button onclick="marcarConfiable('{{ d.mac }}', true, this)"
                class="inline-flex items-center gap-1 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 hover:bg-emerald-100 px-2 py-0.5 rounded-full border border-emerald-200 dark:border-emerald-800 transition">
                <i data-lucide="shield-check" class="w-3 h-3"></i> <span data-i18n="trust_btn">Confiar</span>
              </button>
              {% else %}
              <button onclick="marcarConfiable('{{ d.mac }}', false, this)"
                class="inline-flex items-center gap-1 bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 hover:bg-red-50 hover:text-red-500 px-2 py-0.5 rounded-full border border-gray-200 dark:border-gray-600 transition">
                <i data-lucide="shield-off" class="w-3 h-3"></i> <span data-i18n="untrust_btn">Quitar</span>
              </button>
              {% endif %}
            </td>
            <td class="px-3">
              <button onclick="verPuertos('{{ d.ip }}')" class="inline-flex items-center gap-1 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 hover:bg-blue-100 px-2 py-0.5 rounded-full border border-blue-200 dark:border-blue-800 transition">
                <i data-lucide="search" class="w-3 h-3"></i> <span data-i18n="view_ports">Puertos</span>
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <!-- Agregar MAC + Confiables -->
    <div class="grid gap-4 grid-cols-1 sm:grid-cols-2 mb-4">

      <div class="bg-white dark:bg-dark2 p-4 rounded-xl border border-gray-200 dark:border-gray-700/60 shadow-sm">
        <h2 class="flex items-center gap-1.5 text-sm font-semibold text-gray-700 dark:text-white mb-3">
          <i data-lucide="plus-circle" class="w-4 h-4 text-accent"></i>
          <span data-i18n="addTrusted">Agregar MAC confiable</span>
        </h2>
        <form id="form-agregar" class="flex gap-2">
          <input type="text" id="input-mac" placeholder="00:1A:2B:3C:4D:5E" required
            class="flex-1 p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-dark3 dark:text-white focus:ring-1 focus:ring-accent focus:outline-none text-xs font-mono" />
          <button type="submit" class="bg-gradient-to-r from-accent to-highlight text-white py-2 px-4 rounded-lg text-xs transition hover:opacity-90" data-i18n="add">Agregar</button>
        </form>
      </div>

      <div class="bg-white dark:bg-dark2 p-4 rounded-xl border border-gray-200 dark:border-gray-700/60 shadow-sm">
        <h2 class="flex items-center gap-1.5 text-sm font-semibold text-gray-700 dark:text-white mb-3">
          <i data-lucide="shield" class="w-4 h-4 text-accent"></i>
          <span data-i18n="trustedDevices">Dispositivos Confiables</span>
        </h2>
        <ul id="lista-macs" class="space-y-1.5 custom-scrollbar overflow-y-auto max-h-40">
          {% for item in lista_confiables %}
          <li data-mac="{{ item.mac|lower }}" class="flex justify-between items-center bg-gray-50 dark:bg-dark3/50 px-3 py-2 rounded-lg">
            <div class="flex items-center gap-2">
              <span class="relative flex w-1.5 h-1.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full w-1.5 h-1.5 bg-emerald-500"></span></span>
              <div>
                <p class="nombre-confiable font-medium text-gray-700 dark:text-white">{{ item.nombre if item.nombre else 'Sin nombre' }}</p>
                <p class="font-mono text-gray-400" style="font-size:10px">{{ item.mac }}</p>
              </div>
            </div>
            <button onclick="eliminarMAC('{{ item.mac }}')" class="text-gray-300 hover:text-red-500 transition p-1">
              <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
            </button>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- ══════════ HISTORIAL ══════════ -->
    <section id="seccion-historial" class="hidden fade-in mb-4">
      <div class="bg-white dark:bg-dark2 p-4 rounded-xl border border-l-4 border-highlight/40 border-gray-200 dark:border-gray-700/60 shadow-sm">

        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 mb-3">
          <div>
            <h2 class="flex items-center gap-1.5 text-sm font-semibold text-gray-700 dark:text-white">
              <i data-lucide="activity" class="w-4 h-4 text-highlight"></i>
              <span data-i18n="historyTitle">Historial de red</span>
            </h2>
            <p class="text-gray-400 mt-0.5" style="font-size:10px" data-i18n="historySubtitle">Solo registra conexiones y desconexiones</p>
          </div>
          <div class="flex items-center gap-2 flex-wrap">

            <!-- MAC -->
            <input id="hist-mac" type="text" data-i18n="historyMac" placeholder="Filtrar por MAC"
              class="p-1.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-dark3 focus:ring-1 focus:ring-accent focus:outline-none text-xs font-mono w-36" />

            <!-- Dropdown evento — igual estilo que filtro dispositivos -->
            <div class="relative">
              <button id="histEventoBtn" onclick="document.getElementById('histEventoMenu').classList.toggle('hidden')"
                class="flex items-center justify-between gap-1.5 px-2.5 py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-dark3 hover:bg-accent/10 transition text-xs min-w-[120px]">
                <div class="flex items-center gap-1.5">
                  <span id="hist-evento-dot" class="inline-block w-2 h-2 rounded-full bg-gray-400"></span>
                  <span id="histEventoLabel" data-i18n="historyAll">Todos los eventos</span>
                </div>
                <i data-lucide="chevron-down" class="w-3 h-3 text-accent flex-shrink-0"></i>
              </button>
              <div id="histEventoMenu" class="absolute right-0 z-40 mt-1 w-40 bg-white dark:bg-dark2 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg hidden">
                <button onclick="setHistEvento('','historyAll','bg-gray-400')"       class="w-full px-2.5 py-1.5 text-left hover:bg-accent/10 flex items-center gap-2 text-xs"><span class="w-2 h-2 rounded-full bg-gray-400 flex-shrink-0"></span><span data-i18n="historyAll">Todos los eventos</span></button>
                <button onclick="setHistEvento('conectado','historyConn','bg-emerald-500')"    class="w-full px-2.5 py-1.5 text-left hover:bg-accent/10 flex items-center gap-2 text-xs"><span class="w-2 h-2 rounded-full bg-emerald-500 flex-shrink-0"></span><span data-i18n="historyConn">Conectado</span></button>
                <button onclick="setHistEvento('desconectado','historyDisc','bg-gray-400')" class="w-full px-2.5 py-1.5 text-left hover:bg-accent/10 flex items-center gap-2 text-xs"><span class="w-2 h-2 rounded-full bg-gray-400 flex-shrink-0"></span><span data-i18n="historyDisc">Desconectado</span></button>
              </div>
            </div>

            <button onclick="cargarHistorial()" class="bg-accent hover:bg-highlight text-white px-3 py-1.5 rounded-lg text-xs transition flex items-center gap-1.5">
              <i data-lucide="search" class="w-3 h-3"></i>
              <span data-i18n="historySearch">Buscar</span>
            </button>

            <!-- Auto-refresh toggle -->
            <label class="flex items-center gap-1.5 cursor-pointer select-none text-gray-500 dark:text-gray-400">
              <div class="relative">
                <input type="checkbox" id="hist-auto" class="sr-only peer" checked onchange="toggleAutoRefresh(this.checked)" />
                <div class="w-7 h-4 bg-gray-300 dark:bg-gray-600 peer-checked:bg-accent rounded-full transition"></div>
                <div class="absolute top-0.5 left-0.5 w-3 h-3 bg-white rounded-full transition peer-checked:translate-x-3"></div>
              </div>
              <span data-i18n="historyAutoRefresh" class="text-xs">Auto-actualizar</span>
            </label>
          </div>
        </div>

        <!-- Cards -->
        <div id="historial-cards" class="space-y-1.5 overflow-y-auto max-h-72 custom-scrollbar pr-1">
          <div class="text-center text-gray-400 py-8 text-xs">
            <i data-lucide="clock" class="w-7 h-7 mx-auto mb-1.5 opacity-30"></i>
            <span data-i18n="historyEmpty">Presiona Buscar para cargar el historial</span>
          </div>
        </div>

        <div class="mt-2 flex items-center justify-between">
          <p id="hist-info" class="text-gray-400" style="font-size:10px"></p>
          <button onclick="limpiarHistorial()" class="text-red-400 hover:text-red-600 flex items-center gap-1 transition" style="font-size:10px">
            <i data-lucide="trash-2" class="w-3 h-3"></i>
            <span data-i18n="historyClear">Limpiar historial</span>
          </button>
        </div>
      </div>
    </section>

  </main>

  <!-- ══════════ NOTIFICACIÓN ══════════ -->
  <div id="notificacion" class="fixed bottom-4 right-4 hidden px-4 py-2.5 rounded-lg shadow-lg text-xs font-medium z-50 max-w-xs w-full transition-all duration-300"></div>

  <!-- ══════════ MODAL PUERTOS ══════════ -->
  <div id="modal-puertos" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-dark2 p-5 rounded-xl shadow-xl w-full max-w-sm relative border border-gray-200 dark:border-gray-700 fade-in">
      <button onclick="cerrarModal()" class="absolute top-3 right-3 text-gray-400 hover:text-red-500 transition">
        <i data-lucide="x" class="w-4 h-4"></i>
      </button>
      <h2 class="text-sm font-semibold mb-3 flex items-center gap-2 text-highlight">
        <i data-lucide="server" class="w-4 h-4"></i>
        <span data-i18n="openPorts">Puertos Abiertos</span>
      </h2>
      <div id="contenido-puertos" class="text-xs text-gray-800 dark:text-gray-100 space-y-1.5"></div>
    </div>
  </div>

  <!-- ══════════ MODAL CONFIGURACIÓN ══════════ -->
  <div id="modal-config" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-dark2 p-5 rounded-xl shadow-xl w-full max-w-md relative border border-gray-200 dark:border-gray-700 fade-in max-h-[90vh] overflow-y-auto custom-scrollbar">
      <button onclick="cerrarConfig()" class="absolute top-3 right-3 text-gray-400 hover:text-red-500 transition">
        <i data-lucide="x" class="w-4 h-4"></i>
      </button>
      <h2 class="text-sm font-semibold mb-4 flex items-center gap-2 text-accent">
        <i data-lucide="settings" class="w-4 h-4"></i>
        <span data-i18n="cfgTitle">Configuración del sistema</span>
      </h2>

      <div class="space-y-4">

        <!-- Telegram -->
        <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-200 dark:border-blue-800">
          <h3 class="text-xs font-semibold text-blue-700 dark:text-blue-300 mb-2 flex items-center gap-1.5">
            <i data-lucide="send" class="w-3.5 h-3.5"></i>
            <span data-i18n="cfgTelegram">Notificaciones Telegram</span>
          </h3>
          <div class="space-y-2">
            <div>
              <label class="text-xs text-gray-500 dark:text-gray-400 mb-0.5 block" data-i18n="cfgToken">Bot Token</label>
              <input id="cfg-token" type="password" placeholder="123456:ABC-DEF..."
                class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-dark3 text-xs focus:ring-1 focus:ring-blue-400 focus:outline-none font-mono" />
            </div>
            <div>
              <label class="text-xs text-gray-500 dark:text-gray-400 mb-0.5 block" data-i18n="cfgChatId">Chat ID</label>
              <input id="cfg-chat" type="text" placeholder="-100123456789"
                class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-dark3 text-xs focus:ring-1 focus:ring-blue-400 focus:outline-none font-mono" />
            </div>
            <button onclick="testTelegram()" class="text-xs bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300 hover:bg-blue-200 px-3 py-1.5 rounded-lg transition flex items-center gap-1">
              <i data-lucide="send" class="w-3 h-3"></i>
              <span data-i18n="cfgTestBtn">Probar conexión</span>
            </button>
          </div>
        </div>

        <!-- Monitoreo -->
        <div class="p-3 bg-orange-50 dark:bg-orange-900/20 rounded-xl border border-orange-200 dark:border-orange-800">
          <h3 class="text-xs font-semibold text-orange-700 dark:text-orange-300 mb-2 flex items-center gap-1.5">
            <i data-lucide="timer" class="w-3.5 h-3.5"></i>
            <span data-i18n="cfgMonitoring">Monitoreo de red</span>
          </h3>
          <label class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">
            <span data-i18n="cfgInterval">Intervalo de escaneo</span>
            <span class="text-gray-400 ml-1" data-i18n="cfgIntervalMin">(mín. 30s)</span>
          </label>
          <div class="flex items-center gap-2 mb-2">
            <input id="cfg-intervalo" type="number" min="30" max="3600" value="120"
              class="w-24 p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-dark3 text-xs focus:ring-1 focus:ring-orange-400 focus:outline-none" />
            <span class="text-xs text-gray-500" data-i18n="cfgIntervalUnit">seg</span>
          </div>
          <div class="flex gap-1.5 flex-wrap">
            <button onclick="setIntervalo(30)"  class="text-xs bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 hover:bg-orange-200 px-2 py-1 rounded-full transition">30s</button>
            <button onclick="setIntervalo(60)"  class="text-xs bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 hover:bg-orange-200 px-2 py-1 rounded-full transition">1 min</button>
            <button onclick="setIntervalo(120)" class="text-xs bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 hover:bg-orange-200 px-2 py-1 rounded-full transition">2 min</button>
            <button onclick="setIntervalo(300)" class="text-xs bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 hover:bg-orange-200 px-2 py-1 rounded-full transition">5 min</button>
            <button onclick="setIntervalo(600)" class="text-xs bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 hover:bg-orange-200 px-2 py-1 rounded-full transition">10 min</button>
          </div>
        </div>

        <!-- Sesión configurable -->
        <div class="p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl border border-emerald-200 dark:border-emerald-800">
          <h3 class="text-xs font-semibold text-emerald-700 dark:text-emerald-300 mb-2 flex items-center gap-1.5">
            <i data-lucide="shield" class="w-3.5 h-3.5"></i>
            <span data-i18n="cfgSession">Tiempo de sesión</span>
          </h3>
          <label class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">
            <span data-i18n="cfgSession">Tiempo de sesión</span>
            <span class="text-gray-400 ml-1" data-i18n="cfgSessionMin">(mín. 5 min)</span>
          </label>
          <div class="flex items-center gap-2 mb-2">
            <input id="cfg-session" type="number" min="0.083" max="24" step="0.5" value="8"
              class="w-24 p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-dark3 text-xs focus:ring-1 focus:ring-emerald-400 focus:outline-none" />
            <span class="text-xs text-gray-500" data-i18n="cfgSessionUnit">horas</span>
          </div>
          <div class="flex gap-1.5 flex-wrap mb-2">
            <button onclick="document.getElementById('cfg-session').value=0.5"  class="text-xs bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 hover:bg-emerald-200 px-2 py-1 rounded-full transition">30 min</button>
            <button onclick="document.getElementById('cfg-session').value=1"    class="text-xs bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 hover:bg-emerald-200 px-2 py-1 rounded-full transition">1h</button>
            <button onclick="document.getElementById('cfg-session').value=4"    class="text-xs bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 hover:bg-emerald-200 px-2 py-1 rounded-full transition">4h</button>
            <button onclick="document.getElementById('cfg-session').value=8"    class="text-xs bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 hover:bg-emerald-200 px-2 py-1 rounded-full transition">8h</button>
          </div>
          <p class="text-gray-400" style="font-size:10px" data-i18n="cfgSessionDesc">La sesión se cierra automáticamente tras el tiempo configurado de inactividad.</p>
        </div>

        <!-- Cambiar credenciales -->
        <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-200 dark:border-gray-700">
          <h3 class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-1.5">
            <i data-lucide="key" class="w-3.5 h-3.5"></i>
            <span data-i18n="cfgCredentials">Cambiar credenciales</span>
          </h3>
          <div class="space-y-2">
            <div>
              <label class="text-xs text-gray-500 dark:text-gray-400 mb-0.5 block" data-i18n="cfgCurrentPass">Contraseña actual</label>
              <input id="cfg-pass-actual" type="password"
                class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-dark3 text-xs focus:ring-1 focus:ring-accent focus:outline-none" />
            </div>
            <div>
              <label class="text-xs text-gray-500 dark:text-gray-400 mb-0.5 block" data-i18n="cfgNewEmail">Nuevo correo (opcional)</label>
              <input id="cfg-new-email" type="email" placeholder="nuevo@correo.com"
                class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-dark3 text-xs focus:ring-1 focus:ring-accent focus:outline-none" />
            </div>
            <div>
              <label class="text-xs text-gray-500 dark:text-gray-400 mb-0.5 block" data-i18n="cfgNewPass">Nueva contraseña (opcional)</label>
              <input id="cfg-new-pass" type="password"
                class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-dark3 text-xs focus:ring-1 focus:ring-accent focus:outline-none" />
            </div>
            <div>
              <label class="text-xs text-gray-500 dark:text-gray-400 mb-0.5 block" data-i18n="cfgConfirmPass">Confirmar contraseña</label>
              <input id="cfg-confirm-pass" type="password"
                class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-dark3 text-xs focus:ring-1 focus:ring-accent focus:outline-none" />
            </div>
            <button onclick="guardarCredenciales()"
              class="text-xs bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-accent hover:text-white px-3 py-1.5 rounded-lg transition flex items-center gap-1">
              <i data-lucide="save" class="w-3 h-3"></i>
              <span data-i18n="cfgSave">Guardar cambios</span>
            </button>
            <p id="cfg-cred-msg" class="text-xs hidden"></p>
          </div>
        </div>

      </div>

      <div class="mt-4 flex justify-end gap-2">
        <button onclick="cerrarConfig()" class="px-4 py-1.5 text-xs border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-dark3 transition" data-i18n="cfgCancel">Cancelar</button>
        <button onclick="guardarConfig()" class="px-4 py-1.5 text-xs bg-gradient-to-r from-accent to-highlight text-white rounded-lg hover:opacity-90 transition" data-i18n="cfgSave">Guardar cambios</button>
      </div>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/i18n.js') }}"></script>
  <script src="{{ url_for('static', filename='js/app.js') }}"></script>
  <script src="https://unpkg.com/lucide@latest" defer></script>

  <script>
  // ══════════════════════════════════════
  // SESSION TIMER
  // ══════════════════════════════════════
  const SESSION_TOTAL = {{ session_timeout }} * 1000;
  let sessStart   = Date.now();
  let warnShown   = false;

  function keepAlive() {
    fetch('/api/scan').then(() => {
      sessStart  = Date.now();
      warnShown  = false;
      document.getElementById('sess-warn').classList.add('hidden');
    });
  }

  function tickSession() {
    const elapsed   = Date.now() - sessStart;
    const remaining = SESSION_TOTAL - elapsed;
    if (remaining <= 0) { window.location.href = '/login?timeout=1'; return; }

    const pct = (remaining / SESSION_TOTAL) * 100;
    const bar = document.getElementById('sess-bar');
    if (bar) {
      bar.style.width = pct + '%';
      if      (pct < 10) bar.style.background = '#ef4444';
      else if (pct < 25) bar.style.background = '#f59e0b';
      else               bar.style.background = '';
    }

    if (remaining < 600000 && !warnShown) {
      warnShown = true;
      document.getElementById('sess-warn').classList.remove('hidden');
    }
  }
  setInterval(tickSession, 1000);
  tickSession();

  // ══════════════════════════════════════
  // HISTORIAL DINÁMICO
  // ══════════════════════════════════════
  let _histEvento    = "";
  let _histAutoTimer = null;
  let _histVisible   = false;

  function setHistEvento(valor, labelKey, dotClass) {
    _histEvento = valor;
    document.getElementById('hist-evento-dot').className = `inline-block w-2 h-2 rounded-full ${dotClass} flex-shrink-0`;
    document.getElementById('histEventoLabel').setAttribute('data-i18n', labelKey);
    document.getElementById('histEventoLabel').textContent = t(labelKey);
    document.getElementById('histEventoMenu').classList.add('hidden');
    if (_histVisible) cargarHistorial();
  }

  function actualizarLabelHistorial() {
    const lbl = document.getElementById('histEventoLabel');
    if (lbl) {
      const key = lbl.getAttribute('data-i18n');
      if (key) lbl.textContent = t(key);
    }
  }

  function toggleHistorial() {
    const sec = document.getElementById('seccion-historial');
    _histVisible = sec.classList.toggle('hidden') === false;
    if (_histVisible) {
      cargarHistorial();
      iniciarAutoRefreshHistorial();
    } else {
      detenerAutoRefreshHistorial();
    }
  }

  function toggleAutoRefresh(on) {
    if (on && _histVisible) iniciarAutoRefreshHistorial();
    else detenerAutoRefreshHistorial();
  }

  function iniciarAutoRefreshHistorial() {
    detenerAutoRefreshHistorial();
    const auto = document.getElementById('hist-auto');
    if (!auto?.checked) return;
    _histAutoTimer = setInterval(cargarHistorial, 30000);
  }

  function detenerAutoRefreshHistorial() {
    if (_histAutoTimer) { clearInterval(_histAutoTimer); _histAutoTimer = null; }
  }

  async function cargarHistorial() {
    const mac   = document.getElementById('hist-mac').value.trim();
    const cont  = document.getElementById('historial-cards');
    const info  = document.getElementById('hist-info');

    // Solo mostrar loader si está vacío
    if (!cont.querySelector('.hist-card')) {
      cont.innerHTML = `<div class="text-center text-gray-400 py-6 text-xs flex items-center justify-center gap-2">
        <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> <span data-i18n="historyLoading">${t('historyLoading')}</span>
      </div>`;
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    let url = '/api/historial?limit=100';
    if (mac)        url += `&mac=${encodeURIComponent(mac)}`;
    if (_histEvento) url += `&evento=${encodeURIComponent(_histEvento)}`;

    try {
      const data = await fetch(url).then(r => r.json());
      if (!Array.isArray(data) || data.length === 0) {
        cont.innerHTML = `<div class="text-center text-gray-400 py-6 text-xs">
          <i data-lucide="inbox" class="w-6 h-6 mx-auto mb-1 opacity-30"></i>
          <span data-i18n="historyNoData">${t('historyNoData')}</span>
        </div>`;
        if (typeof lucide !== 'undefined') lucide.createIcons();
        info.textContent = '';
        return;
      }

      cont.innerHTML = data.map(r => {
        const esConn = r.evento === 'conectado';
        const iconBg   = esConn ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400' : 'bg-gray-100 dark:bg-gray-800 text-gray-400 dark:text-gray-500';
        const dotClr   = esConn ? 'bg-emerald-500' : 'bg-gray-300 dark:bg-gray-600';
        const pingSpan = esConn ? `<span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>` : '';
        const evLabel  = `<span class="font-semibold ${esConn ? 'text-emerald-600 dark:text-emerald-400' : 'text-gray-400 dark:text-gray-500'}">${t(esConn ? 'historyConnected' : 'historyDisconnected')}</span>`;
        const trustChip = r.confiable
          ? `<span class="px-1.5 py-0.5 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400" style="font-size:10px">${t('historyTrusted')}</span>`
          : `<span class="px-1.5 py-0.5 rounded-full bg-red-100 dark:bg-red-900/30 text-red-500 dark:text-red-400" style="font-size:10px">${t('historyUntrusted')}</span>`;

        return `<div class="hist-card flex items-center gap-2.5 p-2.5 rounded-lg border border-gray-100 dark:border-gray-700/50 bg-white dark:bg-dark3/60 hover:-translate-y-px hover:shadow-sm transition">
          <div class="relative flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${iconBg}">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              ${esConn
                ? '<path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/>'
                : '<line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.56 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/>'}
            </svg>
            <span class="absolute -bottom-0.5 -right-0.5 w-2 h-2 rounded-full border border-white dark:border-dark3 ${dotClr} overflow-hidden"><span class="relative flex w-full h-full">${pingSpan}<span class="relative inline-flex rounded-full w-full h-full ${dotClr}"></span></span></span>
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-1.5 flex-wrap">
              ${evLabel} ${trustChip}
            </div>
            <div class="flex flex-wrap gap-x-2 text-gray-400 dark:text-gray-500 mt-0.5" style="font-size:10px">
              <span class="font-mono">${r.mac}</span>
              <span>${r.ip}</span>
              ${r.nombre  ? `<span class="text-gray-600 dark:text-gray-300 font-medium">${r.nombre}</span>` : ''}
              ${r.fabricante ? `<span>${r.fabricante}</span>` : ''}
            </div>
          </div>
          <div class="text-right flex-shrink-0" style="font-size:10px">
            <p class="text-gray-400">${r.fecha ? r.fecha.split(' ')[0] : '—'}</p>
            <p class="font-medium text-gray-500">${r.fecha ? r.fecha.split(' ')[1] : ''}</p>
          </div>
        </div>`;
      }).join('');

      info.textContent = `${data.length} ${t('historyCount')}`;
    } catch {
      cont.innerHTML = `<div class="text-center text-red-400 py-6 text-xs" data-i18n="historyError">${t('historyError')}</div>`;
    }
  }

  async function limpiarHistorial() {
    if (!confirm(t('historyClear') + '?')) return;
    const r = await fetch('/api/historial/limpiar', { method: 'POST' }).then(r => r.json()).catch(() => null);
    if (r?.success) cargarHistorial();
  }

  // Input MAC historial — busca mientras escribe (debounce)
  let _histDebounce = null;
  document.getElementById('hist-mac')?.addEventListener('input', () => {
    clearTimeout(_histDebounce);
    _histDebounce = setTimeout(() => { if (_histVisible) cargarHistorial(); }, 400);
  });

  // ══════════════════════════════════════
  // CONFIGURACIÓN
  // ══════════════════════════════════════
  async function abrirConfig() {
    document.getElementById('modal-config').classList.remove('hidden');
    try {
      const data = await fetch('/api/configuracion').then(r => r.json());
      document.getElementById('cfg-token').value    = data.telegram_token    || '';
      document.getElementById('cfg-chat').value     = data.telegram_chat_id  || '';
      document.getElementById('cfg-intervalo').value = data.intervalo_monitoreo || '120';
      document.getElementById('cfg-session').value  = ((parseInt(data.session_timeout) || 28800) / 3600).toFixed(1);
    } catch(e) { console.warn('No se pudo cargar config:', e); }
    if (typeof lucide !== 'undefined') lucide.createIcons();
  }

  function cerrarConfig() {
    document.getElementById('modal-config').classList.add('hidden');
    ['cfg-pass-actual','cfg-new-email','cfg-new-pass','cfg-confirm-pass'].forEach(id => {
      const el = document.getElementById(id); if (el) el.value = '';
    });
    const msg = document.getElementById('cfg-cred-msg');
    if (msg) msg.classList.add('hidden');
  }

  async function guardarConfig() {
    const token    = document.getElementById('cfg-token').value.trim();
    const chat     = document.getElementById('cfg-chat').value.trim();
    const intervalo = parseInt(document.getElementById('cfg-intervalo').value) || 120;
    const sessionH  = parseFloat(document.getElementById('cfg-session').value) || 8;
    const sessionS  = Math.max(300, Math.round(sessionH * 3600));

    try {
      const res  = await fetch('/api/configuracion', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ telegram_token: token, telegram_chat_id: chat, intervalo_monitoreo: intervalo, session_timeout: sessionS })
      });
      const data = await res.json();
      mostrarNotificacion(data.success ? `✓ ${t('cfgSaved')}` : `✗ ${t('cfgError')}`, data.success ? 'success' : 'error');
      if (data.success) cerrarConfig();
    } catch {
      mostrarNotificacion(`✗ ${t('cfgError')}`, 'error');
    }
  }

  async function testTelegram() {
    const token = document.getElementById('cfg-token').value.trim();
    const chat  = document.getElementById('cfg-chat').value.trim();
    if (token) await fetch('/api/configuracion', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({telegram_token:token,telegram_chat_id:chat}) });
    const res  = await fetch('/api/telegram/test', { method:'POST' }).then(r => r.json()).catch(() => null);
    mostrarNotificacion(res?.success ? `✓ ${res.message}` : `✗ ${res?.message || t('cfgError')}`, res?.success ? 'success' : 'error');
  }

  function setIntervalo(val) { document.getElementById('cfg-intervalo').value = val; }

  async function guardarCredenciales() {
    const actual   = document.getElementById('cfg-pass-actual').value;
    const email    = document.getElementById('cfg-new-email').value.trim();
    const newPass  = document.getElementById('cfg-new-pass').value;
    const confirm  = document.getElementById('cfg-confirm-pass').value;
    const msg      = document.getElementById('cfg-cred-msg');

    if (!actual) {
      msg.textContent = t('cfgCurrentPass') + ' es requerida';
      msg.className   = 'text-xs text-red-500';
      msg.classList.remove('hidden');
      return;
    }

    try {
      const res  = await fetch('/api/cambiar-credenciales', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contrasena_actual: actual, nuevo_usuario: email, nueva_contrasena: newPass, confirmar_contrasena: confirm })
      });
      const data = await res.json();
      msg.textContent = data.success ? `✓ ${t('cfgCredSaved')}` : `✗ ${data.message || t('cfgCredError')}`;
      msg.className   = `text-xs ${data.success ? 'text-emerald-500' : 'text-red-500'}`;
      msg.classList.remove('hidden');
      if (data.success) setTimeout(() => msg.classList.add('hidden'), 3000);
    } catch {
      msg.textContent = `✗ ${t('cfgCredError')}`;
      msg.className   = 'text-xs text-red-500';
      msg.classList.remove('hidden');
    }
  }

  // ══════════════════════════════════════
  // MARCAR CONFIABLE DESDE TABLA (toggle sin reload)
  // ══════════════════════════════════════
  window.marcarConfiable = async (mac, hacerConfiable, btn) => {
    const endpoint = hacerConfiable ? '/api/agregar' : '/api/eliminar';
    try {
      const res  = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mac })
      });
      const data = await res.json();
      if (!data.success) { mostrarNotificacion(`✗ ${t('connectionError')}`, 'error'); return; }

      const tr = btn.closest('tr');
      if (!tr) return;
      tr.dataset.confianza = hacerConfiable ? 'confiable' : 'no-confiable';

      // Actualizar badge confianza
      const tdConfianza = tr.querySelector('td:nth-child(5)');
      if (tdConfianza) {
        tdConfianza.innerHTML = hacerConfiable
          ? `<span class="inline-flex items-center gap-1 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 px-2 py-0.5 rounded-full font-medium"><span class="relative flex w-1.5 h-1.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full w-1.5 h-1.5 bg-emerald-500"></span></span><span data-i18n="trusted">${t('trusted')}</span></span>`
          : `<span class="inline-flex items-center gap-1 bg-red-100 dark:bg-red-900/20 text-red-600 dark:text-red-400 px-2 py-0.5 rounded-full font-medium"><span class="w-1.5 h-1.5 rounded-full bg-gray-400"></span><span data-i18n="untrusted">${t('untrusted')}</span></span>`;
      }
      // Actualizar botón acción
      btn.outerHTML = hacerConfiable
        ? `<button onclick="marcarConfiable('${mac}', false, this)" class="inline-flex items-center gap-1 bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 hover:bg-red-50 hover:text-red-500 px-2 py-0.5 rounded-full border border-gray-200 dark:border-gray-600 transition"><i data-lucide="shield-off" class="w-3 h-3"></i> <span data-i18n="untrust_btn">${t('untrust_btn')}</span></button>`
        : `<button onclick="marcarConfiable('${mac}', true, this)"  class="inline-flex items-center gap-1 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 hover:bg-emerald-100 px-2 py-0.5 rounded-full border border-emerald-200 dark:border-emerald-800 transition"><i data-lucide="shield-check" class="w-3 h-3"></i> <span data-i18n="trust_btn">${t('trust_btn')}</span></button>`;

      if (typeof lucide !== 'undefined') lucide.createIcons();
      mostrarNotificacion(hacerConfiable ? `✓ ${t('success')}` : `✓ ${t('eliminado')}`, 'success');

      // Actualizar lista sidebar
      const lista = document.getElementById('lista-macs');
      if (hacerConfiable && lista) {
        const li = document.createElement('li');
        li.dataset.mac = mac.toLowerCase();
        li.className = 'flex justify-between items-center bg-gray-50 dark:bg-dark3/50 px-3 py-2 rounded-lg';
        li.innerHTML = `<div class="flex items-center gap-2"><span class="relative flex w-1.5 h-1.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full w-1.5 h-1.5 bg-emerald-500"></span></span><div><p class="nombre-confiable font-medium text-gray-700 dark:text-white">Sin nombre</p><p class="font-mono text-gray-400" style="font-size:10px">${mac}</p></div></div><button onclick="eliminarMAC('${mac}')" class="text-gray-300 hover:text-red-500 transition p-1"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>`;
        lista.appendChild(li);
        if (typeof lucide !== 'undefined') lucide.createIcons();
      } else if (!hacerConfiable && lista) {
        lista.querySelector(`li[data-mac="${mac.toLowerCase()}"]`)?.remove();
      }
    } catch {
      mostrarNotificacion(`✗ ${t('connectionError')}`, 'error');
    }
  };

  // Cerrar menús y modales con Escape
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') { cerrarModal?.(); cerrarConfig?.(); }
  });
  </script>

</body>
</html>
